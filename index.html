<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Tic-Tac-Toe üéÆ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for Sound Effects -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <style>
        /* Custom styles for the game board */
        
        /* Enhanced Body Style with Dark Theme and Background Image */
        .bg-tictactoe-pattern {
            background-color: #0d1117; /* Dark charcoal/blue */
            /* Using a secure placeholder that looks like a futuristic grid */
            background-image: url('https://placehold.co/1920x1080/0d1117/ffffff?text=FUTURISTIC+GRID'); 
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            aspect-ratio: 1 / 1; /* Keep it square */
            max-width: 400px;
            margin: 0 auto;
        }
        .cell {
            min-width: 70px;
            min-height: 70px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            background-color: #2d3748; /* Darker cell background */
            border: 2px solid #4a5568; /* Slightly lighter border */
            border-radius: 8px; /* Added slight rounding to cells */
        }
        .cell:hover:not(.occupied) {
            background-color: #4a5568; /* Hover effect */
        }
        /* Override border styles to create the grid look */
        .cell:nth-child(3n) { border-right: 2px solid #4a5568; }
        .cell:nth-child(3n + 1) { border-left: 2px solid #4a5568; }
        .cell:nth-child(n+7) { border-bottom: 2px solid #4a5568; }
        .cell:nth-child(-n+3) { border-top: 2px solid #4a5568; }


        .occupied {
            cursor: default !important;
            opacity: 0.9;
        }

        /* Styling for X and O */
        .text-x { color: #f56565; /* Brighter Red */ }
        .text-o { color: #63b3ed; /* Brighter Blue */ }

        /* Custom scrollbar for game list */
        #gameList::-webkit-scrollbar {
            width: 8px;
        }
        #gameList::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }
        #gameList::-webkit-scrollbar-thumb {
            background: #4a5568; 
            border-radius: 10px;
        }
        #gameList::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-tictactoe-pattern min-h-screen font-sans text-gray-100 p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-gray-900 shadow-2xl rounded-xl p-6 md:p-10 border border-gray-700">
        <h1 class="text-4xl font-extrabold text-center mb-6 text-white flex items-center justify-center">
            Multiplayer Tic-Tac-Toe ‚ùå‚≠ï
        </h1>

        <div id="authStatus" class="text-sm text-center mb-4 p-2 bg-blue-900 text-blue-300 rounded-lg">
            ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...
        </div>
        
        <div id="audioStatus" class="text-sm text-center mb-4 p-2 bg-pink-900 text-pink-300 rounded-lg hidden">
            üîä ‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶è‡¶®‡¶æ‡¶¨‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡ßá ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï/‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®!
        </div>

        <!-- Main Game Area -->
        <div id="gameContainer" class="flex flex-col lg:flex-row gap-8">

            <!-- Left: Game List & Controls -->
            <div class="lg:w-1/3 p-4 bg-gray-800 rounded-lg shadow-inner border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 text-gray-200">‡¶ó‡ßá‡¶Æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h2>
                
                <button id="createGameBtn" class="w-full mb-4 py-3 px-4 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150 ease-in-out disabled:bg-gray-600 disabled:shadow-none" disabled>
                    ‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßá‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>

                <div id="gameList" class="max-h-64 overflow-y-auto space-y-2 pr-2">
                    <!-- Game items will be rendered here -->
                    <p class="text-gray-400 text-sm italic text-center">‡¶ó‡ßá‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-700">
                    <p class="text-xs text-gray-400 font-medium">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø:</p>
                    <p id="currentUserId" class="text-sm font-mono break-all bg-gray-700 p-2 rounded mt-1 text-gray-100">...</p>
                </div>
            </div>

            <!-- Right: Current Game Board -->
            <div class="lg:w-2/3 flex flex-col items-center">
                <div id="gameStatus" class="text-2xl font-bold mb-6 p-3 rounded-xl w-full text-center bg-yellow-800 text-yellow-100 shadow-md">
                    ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ó‡ßá‡¶Æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶¨‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                </div>

                <div id="boardContainer" class="board bg-gray-800 p-2 rounded-xl shadow-2xl transition duration-300 ease-in-out scale-0 hidden">
                    <!-- Board cells will be rendered here -->
                </div>
                
                <button id="resetGameBtn" class="mt-6 py-2 px-6 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition duration-150 ease-in-out hidden" onclick="resetCurrentGame(); playClickSound();">
                    ‡¶ó‡ßá‡¶Æ‡¶ü‡¶ø ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, query, 
            updateDoc, onSnapshot, setDoc, getDoc,
            serverTimestamp, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Set log level for debugging
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES (Canvas Environment) ---
        // Canvas ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂ ‡¶•‡ßá‡¶ï‡ßá Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§
        
        // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá (Canvas ‡¶¨‡¶æ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-tictactoe-app';
        
        let firebaseConfig = null;
        try {
            // Canvas ‡¶•‡ßá‡¶ï‡ßá Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® JSON ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        } catch (e) {
            console.error("Failed to parse __firebase_config:", e);
        }

        // ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤ ‡¶Ö‡¶• ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        // --- FIREBASE SETUP ---
        let app;
        let db;
        let auth;
        let userId = null;
        let currentGameId = null;
        let currentUnsubscribe = null; 

        // Constants
        const COLLECTION_PATH = `/artifacts/${appId}/public/data/tictactoe_games`;
        const INITIAL_BOARD = Array(9).fill(null);
        const WINNING_COMBOS = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], 
            [0, 3, 6], [1, 4, 7], [2, 5, 8], 
            [0, 4, 8], [2, 4, 6]             
        ];

        // --- DOM ELEMENTS ---
        const authStatusEl = document.getElementById('authStatus');
        const audioStatusEl = document.getElementById('audioStatus'); // New audio status element
        const currentUserIdEl = document.getElementById('currentUserId');
        const createGameBtn = document.getElementById('createGameBtn');
        const gameListEl = document.getElementById('gameList');
        const gameStatusEl = document.getElementById('gameStatus');
        const boardContainer = document.getElementById('boardContainer');
        const resetGameBtn = document.getElementById('resetGameBtn');

        // --- SOUND FUNCTIONS (using global Tone object) ---
        let synth;
        let clickSynth;
        let winSynth;

        function initAudio() {
            if (typeof Tone === 'undefined') {
                 console.error("Tone.js is not loaded.");
                 return;
            }

            // Start audio context on first interaction to comply with browser policy
            const startAudio = () => {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                    audioStatusEl.classList.add('hidden');
                    console.log("Audio context started.");
                }
            };
            
            document.documentElement.addEventListener('mousedown', startAudio, { once: true });
            document.documentElement.addEventListener('touchstart', startAudio, { once: true });
            audioStatusEl.classList.remove('hidden');

            try {
                // Synth for moves (short, sharp click)
                synth = new Tone.MembraneSynth().toDestination();
                
                // Synth for button clicks
                clickSynth = new Tone.Synth({
                    oscillator: { type: "square" },
                    envelope: { attack: 0.005, decay: 0.05, sustain: 0, release: 0.1 }
                }).toDestination();
                
                // PolySynth for victory/draw jingle
                winSynth = new Tone.PolySynth(Tone.Synth).toDestination();

            } catch (e) {
                console.warn("Audio initialization failed. Sounds will be disabled.", e);
            }
        }

        window.playMoveSound = function() {
            if (synth && Tone.context.state === 'running') {
                synth.triggerAttackRelease("C4", "8n");
            }
        }

        window.playClickSound = function() {
            if (clickSynth && Tone.context.state === 'running') {
                clickSynth.triggerAttackRelease("A3", "16n");
            }
        }

        function playWinSound() {
            if (winSynth && Tone.context.state === 'running') {
                const now = Tone.now();
                winSynth.triggerAttackRelease(["C5", "E5", "G5"], "4n", now);
            }
        }

        function playDrawSound() {
            if (winSynth && Tone.context.state === 'running') {
                const now = Tone.now();
                winSynth.triggerAttackRelease(["C4", "D#4", "G#4"], "4n", now);
            }
        }


        // --- UTILITY FUNCTIONS ---
        
        function getPlayerId(game, marker) {
            return marker === 'X' ? game.playerXId : game.playerOId;
        }

        function checkGameState(board) {
            for (const combo of WINNING_COMBOS) {
                const [a, b, c] = combo;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return { winner: board[a], status: 'finished' };
                }
            }

            if (board.every(cell => cell !== null)) {
                return { winner: 'draw', status: 'finished' };
            }

            return { winner: null, status: 'in_progress' };
        }

        // --- UI RENDER FUNCTIONS ---
        
        function showMessage(message, type = 'info') {
            let bgColor = 'bg-yellow-800';
            let textColor = 'text-yellow-100';

            if (type === 'success') {
                bgColor = 'bg-green-800';
                textColor = 'text-green-100';
            } else if (type === 'error') {
                bgColor = 'bg-red-800';
                textColor = 'text-red-100';
            } else if (type === 'turn') {
                bgColor = 'bg-blue-800';
                textColor = 'text-blue-100';
            }

            gameStatusEl.textContent = message;
            gameStatusEl.className = `text-2xl font-bold mb-6 p-3 rounded-xl w-full text-center shadow-md ${bgColor} ${textColor}`;
        }

        let previousGameStatus = null; // Track status to trigger end-game sounds only once

        function renderGameBoard(game) {
            boardContainer.innerHTML = '';
            boardContainer.classList.remove('scale-0');
            boardContainer.classList.add('scale-100');
            boardContainer.classList.remove('hidden');
            
            const isGameFinished = game.status === 'finished';

            if (isGameFinished) {
                resetGameBtn.classList.remove('hidden');
            } else {
                resetGameBtn.classList.add('hidden');
            }

            game.board.forEach((marker, index) => {
                const cell = document.createElement('div');
                cell.classList.add('cell', 'text-gray-900');
                cell.setAttribute('data-index', index);

                if (marker) {
                    cell.textContent = marker;
                    cell.classList.add('occupied');
                    cell.classList.add(marker === 'X' ? 'text-x' : 'text-o');
                } else {
                    // Attach click handler only if game is in progress
                    if (game.status === 'in_progress' && getPlayerId(game, game.turn) === userId) {
                        cell.addEventListener('click', () => makeMove(game, index));
                        cell.classList.add('hover:bg-gray-700');
                    }
                }
                boardContainer.appendChild(cell);
            });

            // Update status message
            let playerMarker = null;
            if (game.playerXId === userId) playerMarker = 'X';
            if (game.playerOId === userId) playerMarker = 'O';

            // --- Sound Triggering Logic ---
            if (isGameFinished) {
                if (previousGameStatus !== 'finished') {
                    if (game.winner === 'draw') {
                        playDrawSound();
                    } else {
                        playWinSound();
                    }
                }
                
                if (game.winner === 'draw') {
                    showMessage("‡¶ó‡ßá‡¶Æ ‡¶∂‡ßá‡¶∑! ‡¶°‡ßç‡¶∞ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ü§ù", 'info');
                } else if (game.winner === playerMarker) {
                    showMessage(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ú‡¶ø‡¶§‡ßá‡¶õ‡ßá‡¶®! üéâ`, 'success');
                } else {
                    showMessage(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶π‡ßá‡¶∞‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡¶®‡•§ üò¢ (${game.winner} ‡¶ú‡¶ø‡¶§‡ßá‡¶õ‡ßá)`, 'error');
                }

            } else if (game.status === 'waiting') {
                 if (playerMarker === 'X') {
                    showMessage(`‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü ‡¶ñ‡ßá‡¶≤‡ßã‡ßü‡¶æ‡ßú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`, 'info');
                } else {
                    showMessage(`‡¶ó‡ßá‡¶Æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`, 'info');
                }
            } else if (game.status === 'in_progress') {
                if (game.turn === playerMarker) {
                    showMessage(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶æ‡¶≤‡¶æ! (${playerMarker}) ‡¶¶‡¶ø‡¶®! üëÜ`, 'turn');
                } else {
                    showMessage(`‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶™‡¶æ‡¶≤‡¶æ (${game.turn}) ‚è≥`, 'info');
                }
            }

            previousGameStatus = game.status;
        }

        function renderGamesList(games) {
            gameListEl.innerHTML = '';
            if (games.length === 0) {
                gameListEl.innerHTML = '<p class="text-gray-400 text-sm italic p-2 text-center">‡¶ï‡ßã‡¶®‡ßã ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶ó‡ßá‡¶Æ ‡¶®‡ßá‡¶á‡•§ ‡¶Ü‡¶™‡¶®‡¶ø‡¶á ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®!</p>';
                return;
            }

            games.forEach(game => {
                const gameEl = document.createElement('div');
                // Use a slightly different background for list items
                gameEl.classList.add('p-3', 'rounded-lg', 'shadow-sm', 'transition', 'duration-150', 'bg-gray-700');
                
                let buttonText = '‡¶ñ‡ßá‡¶≤‡¶õ‡ßá';
                let buttonBg = 'bg-gray-500';
                
                if (game.status === 'waiting') {
                    buttonText = '‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶®';
                    buttonBg = 'bg-blue-500 hover:bg-blue-600';
                }

                gameEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-200 truncate mr-2">‡¶ó‡ßá‡¶Æ: ${game.id.substring(0, 8)}...</span>
                        ${game.status === 'waiting' ? '<span class="text-xs font-semibold px-2 py-1 rounded-full bg-blue-700 text-blue-100">‡ßß/‡ß® ‡¶ñ‡ßá‡¶≤‡ßã‡ßü‡¶æ‡ßú</span>' : ''}
                    </div>
                    <div class="mt-1 flex justify-between items-center">
                        <span class="text-sm text-gray-400 italic">‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® ${game.playerXId.substring(0, 6)}...</span>
                        <button class="join-btn text-sm font-semibold py-1 px-3 rounded-full ${buttonBg} text-white disabled:bg-gray-600" 
                                data-game-id="${game.id}" 
                                ${game.playerXId === userId || game.status !== 'waiting' ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
                
                // Highlight the currently selected game
                if (game.id === currentGameId) {
                    gameEl.classList.remove('bg-gray-700');
                    gameEl.classList.add('bg-blue-900', 'border-blue-500', 'border');
                } else {
                    gameEl.classList.add('hover:bg-gray-600', 'cursor-pointer');
                }


                gameListEl.appendChild(gameEl);
            });

            // Attach listeners to join buttons
            gameListEl.querySelectorAll('.join-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.playClickSound(); // Play sound on button click
                    const gameId = e.currentTarget.getAttribute('data-game-id');
                    joinGame(gameId);
                });
            });
        }

        // --- FIRESTORE FUNCTIONS ---

        function loadGamesListener() {
            const q = query(collection(db, COLLECTION_PATH));

            return onSnapshot(q, (snapshot) => {
                const games = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Filter out games that are full and finished unless they are the current game
                    if (data.status === 'waiting' || data.id === currentGameId) {
                         games.push({ id: doc.id, ...data });
                    }
                });
                // Note: Sorting is done here in JS, not Firestore, to avoid index requirements.
                games.sort((a, b) => (b.lastMoveTime?.seconds || 0) - (a.lastMoveTime?.seconds || 0));
                
                renderGamesList(games);
            }, (error) => {
                console.error("Error fetching games:", error);
                showMessage("‡¶ó‡ßá‡¶Æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶ï‡¶®‡¶∏‡ßã‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®‡•§", 'error');
            });
        }

        async function createGame() {
            window.playClickSound(); // Play sound on button click
            try {
                createGameBtn.disabled = true;
                const newGameRef = doc(collection(db, COLLECTION_PATH));
                const newGame = {
                    id: newGameRef.id,
                    board: INITIAL_BOARD,
                    status: 'waiting',
                    turn: 'X',
                    playerXId: userId,
                    playerOId: null,
                    winner: null,
                    lastMoveTime: serverTimestamp()
                };

                await setDoc(newGameRef, newGame);
                
                joinGame(newGameRef.id);

            } catch (e) {
                console.error("Error creating document: ", e);
                showMessage("‡¶ó‡ßá‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", 'error');
            } finally {
                createGameBtn.disabled = false;
            }
        }

        async function joinGame(gameId) {
            if (currentUnsubscribe) {
                currentUnsubscribe();
            }
            
            currentGameId = gameId;

            try {
                const gameRef = doc(db, COLLECTION_PATH, gameId);
                const gameSnap = await getDoc(gameRef);

                if (!gameSnap.exists()) {
                    showMessage("‡¶ó‡ßá‡¶Æ‡¶ü‡¶ø ‡¶Ü‡¶∞ ‡¶®‡ßá‡¶á‡•§", 'error');
                    currentGameId = null;
                    return;
                }

                let game = gameSnap.data();
                
                // If waiting, join as O
                if (game.status === 'waiting' && game.playerXId !== userId) {
                    await updateDoc(gameRef, {
                        playerOId: userId,
                        status: 'in_progress',
                        lastMoveTime: serverTimestamp()
                    });
                    game = (await getDoc(gameRef)).data();
                } else if (game.playerXId !== userId && game.playerOId !== userId && game.status !== 'finished') {
                    showMessage("‡¶ó‡ßá‡¶Æ‡¶ü‡¶ø ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶ö‡¶≤‡¶õ‡ßá‡•§", 'error');
                    currentGameId = null;
                    return;
                }

                // Start listening to the game document
                currentUnsubscribe = onSnapshot(gameRef, (doc) => {
                    if (doc.exists()) {
                        renderGameBoard(doc.data());
                    } else {
                        showMessage("‡¶ó‡ßá‡¶Æ‡¶ü‡¶ø ‡¶∂‡ßá‡¶∑ ‡¶¨‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§", 'info');
                        currentGameId = null;
                        boardContainer.innerHTML = '';
                        boardContainer.classList.add('hidden');
                        resetGameBtn.classList.add('hidden');
                    }
                }, (error) => {
                    console.error("Error listening to game:", error);
                    showMessage("‡¶ó‡ßá‡¶Æ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§", 'error');
                });

            } catch (e) {
                console.error("Error joining game: ", e);
                showMessage("‡¶ó‡ßá‡¶Æ‡¶ü‡¶ø‡¶§‡ßá ‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§", 'error');
                currentGameId = null;
            }
        }

        async function makeMove(game, index) {
            const playerMarker = game.playerXId === userId ? 'X' : 'O';
            
            if (game.status !== 'in_progress' || game.turn !== playerMarker || game.board[index] !== null) {
                return;
            }
            
            // Play move sound immediately for responsiveness (real-time listener will sync it)
            window.playMoveSound(); 

            try {
                const newBoard = [...game.board];
                newBoard[index] = playerMarker;

                const { winner, status } = checkGameState(newBoard);
                const nextTurn = playerMarker === 'X' ? 'O' : 'X';

                const updatePayload = {
                    board: newBoard,
                    turn: nextTurn,
                    lastMoveTime: serverTimestamp()
                };

                if (status === 'finished') {
                    updatePayload.status = 'finished';
                    updatePayload.winner = winner;
                }

                const gameRef = doc(db, COLLECTION_PATH, currentGameId);
                await updateDoc(gameRef, updatePayload);

            } catch (e) {
                console.error("Error making move: ", e);
                showMessage("‡¶ö‡¶æ‡¶≤ ‡¶¶‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", 'error');
            }
        }

        window.resetCurrentGame = async function() {
            if (!currentGameId) return;

            try {
                const gameRef = doc(db, COLLECTION_PATH, currentGameId);
                await updateDoc(gameRef, {
                    board: INITIAL_BOARD,
                    status: 'in_progress',
                    turn: 'X',
                    winner: null,
                    lastMoveTime: serverTimestamp()
                });
                previousGameStatus = null; // Reset status tracker for sound
            } catch (e) {
                console.error("Error resetting game:", e);
                showMessage("‡¶ó‡ßá‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§", 'error');
            }
        }


        // --- AUTHENTICATION & INITIALIZATION ---

        async function initAuth() {
            // Check if Firebase config is missing (only relevant if not running in Canvas and user forgot to set fallbacks)
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                const message = '‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ERROR: Firebase ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶Ö‡¶®‡ßÅ‡¶™‡¶∏‡ßç‡¶•‡¶ø‡¶§‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶Ü‡¶á‡¶°‡¶ø: ' + appId;
                authStatusEl.textContent = message;
                authStatusEl.classList.remove('bg-blue-900');
                authStatusEl.classList.add('bg-red-900', 'text-red-300');
                console.error(message);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Firebase initialization error:", error);
                authStatusEl.textContent = '‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ERROR: Firebase ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§';
                authStatusEl.classList.remove('bg-blue-900');
                authStatusEl.classList.add('bg-red-900', 'text-red-300');
                return; 
            }
            
            authStatusEl.textContent = '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            
            // Listen for auth state changes ONLY AFTER 'auth' is successfully initialized
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    currentUserIdEl.textContent = userId;
                    
                    authStatusEl.textContent = '‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§';
                    authStatusEl.classList.remove('bg-blue-900', 'text-blue-300');
                    authStatusEl.classList.add('bg-green-900', 'text-green-300');
                    
                    createGameBtn.disabled = false;
                    createGameBtn.addEventListener('click', createGame);

                    loadGamesListener(); // Start loading games list

                } else {
                    userId = null;
                    currentUserIdEl.textContent = '...';
                    // Only update status if no fatal error occurred earlier
                    if (authStatusEl.textContent.indexOf('ERROR') === -1) {
                         authStatusEl.textContent = '‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡•§';
                    }
                    createGameBtn.disabled = true;
                }
            });

            // Sign in using custom token if available, otherwise anonymously
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
        }

        window.onload = async function() {
            initAudio(); // Initialize audio components
            await initAuth(); // Start the entire auth process
        }
    </script>
</body>
</html>
